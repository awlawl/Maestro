<!DOCTYPE html>
<html>
  <head>
    <title>Maestro</title>
      <div id="pubnub" 
           pub-key="demo" 
           sub-key="demo" ssl="off" origin="pubsub.pubnub.com">
      </div>

    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/css/bootstrap-combined.min.css" rel="stylesheet">
      <style>
          body {
			font-size: 18px;
			/*padding-top: 60px;*/
			padding-bottom: 40px;
		}
      </style> 
      <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
      <script src="http://cdn.pubnub.com/pubnub-3.3.min.js"></script>
      <script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js"></script>
      <script src="/Scripts/Maestro.js"></script>
      

    <script>

        var channel = 'maestrotest';
        var hostRootUrl = '';
        var viewModel = new MaestroViewModel();
        
        $(document).ready(function () {
            $("#btnPlay").click(play);
            $("#btnStop").click(stop);
            $("#btnNext").click(next);
            $("#btnBack").click(back);
            $("#btnPause").click(pause);
            
            PUBNUB.subscribe({
                channel: channel,
                callback: function (message) {
                    console.log(JSON.stringify(message));
                    handleMessage(message);

                },
                error: function () {
                    // The internet is gone.
                    console.log("###Connection Lost");
                },
                connect: function () {
                    console.log("Now listening.");
                    ping();

                }
            });

            
            ko.applyBindings(viewModel);
        });
          
        function publishMessage(message) {
	
            PUBNUB.publish({
                channel: 'maestrotest',
                message: message,
                callback: function (info) {
                    console.log("Wrote message");
                    if (!info[0]) {
                        console.log("!!!!!!!!!!!!!!!!!!!! Failed! -> " + info[1]);
                      
                    } 
                }
            });
        };

        function play() {
            publishMessage({ action: "Play" });
        }

        function stop() {
            publishMessage({ action: "Stop" });
        }

        function next() {
            publishMessage({ action: "Next" });
        }

        function back() {
            publishMessage({ action: "Back" });
        }
        
        function pause() {
            publishMessage({ action: "Pause" });
        }
        
        function ping() {
            publishMessage({ action: "Ping" });
        }
        
        function handleMessage(message) {
            if (message.action == "Now Playing") {
                nowPlaying(message.data);
            } else if (message.action == "Ping Reply") {
                pingReply(message.data);
            }
        }
        
        function nowPlaying(songInfo) {
            viewModel.artist(setField(songInfo.Artist));
            viewModel.title(songInfo.Title);
            viewModel.album(songInfo.Album);
            refreshAlbumArt();
        }
        
        function pingReply(pingData) {
            hostRootUrl = pingData.HostRootUrl;
            refreshAlbumArt();
        }

        function refreshAlbumArt() {
            viewModel.albumArt(hostRootUrl + "/AlbumArt?" + (new Date()).getTime().toString());
        }
        
        function setField(id, val) {
            if (!val)
                val = '...';
            
            return val;
        }
          
    </script>
  </head>
    <body >
        <div class="row">
            <div class="span5" >
                <img style="width: 200px" data-bind="attr: {src:albumArt}"/>
            </div>
        </div>
        <div class="row">
            <div class="span5" id="divNowPlaying" >
                <dl class="dl-horizontal">
                    <dt>Artist</dt>
                    <dd data-bind="text: artist"></dd>
                    <dt>Title</dt>
                    <dd data-bind="text: title"></dd>
                    <dt>Album</dt>
                    <dd data-bind="text: album"></dd>
                </dl>
            </div>
        </div>
        <div class="span5">
            <button id="btnBack" class="btn">&lt;&lt; Back</button> <button id="btnPlay" class="btn">Play</button> <button id="btnPause" class="btn">Pause</button> <button id="btnStop" class="btn" >Stop</button> <button id="btnNext" class="btn" >Next &gt;&gt;</button>
        </div>
    
        <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/js/bootstrap.min.js"></script>
    </body>
</html>